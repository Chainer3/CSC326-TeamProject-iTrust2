<html xmlns:th="http://www.thymeleaf.org">
<head th:include="layout :: head(title=~{::title},links=~{::script})">
<title>Billing Member: Pay Bills</title>
<script th:src="@{/js/dateTimeService.js}"
		src="../js/dateTimeService.js"></script>
</head>
<body th:include="layout :: body" th:with="content=~{::content}">

	<div th:fragment="content">
		<script th:inline="javascript">
            var app = angular.module('myApp', ['dateTimeServices']);
            //angular.module("cptsApp").controller('billsCtrl', function ($scope, $http, dateTimeService) {
            app.controller('billsCtrl', function($scope, $http, dateTimeService) {
            	
            	// Fields to construct Patient section of bills page
            	
            	// The list of bills available for the billing staff member 
            	$scope.allBills = [];
            	
            	// The bill selected by the billing staff member to add a payment
            	$scope.bill = 0;
            	
            	// A list of patients to be selected by the user for a specific bill
            	//$scope.selectPatient = [];
            	
            	// The current 
            	//$scope.patient = {};
            	
            	// String showing what payment method is being used
            	$scope.paymentMethod = "";
            	
            	// The amount input by the user
            	$scope.paymentAmount = 0;
            	
            	$scope.addPayment = {
            			"amount":0,
            			"paymentMethod":""
            	};
            	
            	$scope.totalBill = 10;
            	
            	$scope.isFull = 0;
           
                //Updates the table with the most current data
            	$scope.updateTable = function() {
                    $http.get("/iTrust2/api/v1/bills").then(
                    		function(response) {
                                $scope.allBills = response.data;
                                $scope.message = "";
                                $scope.enableEdit = false;
                    		}, function(rejection) {
                    			$scope.cpts = [];
                    			$scope.cpts = "Could not display CPT Codes";
                    });
                    $scope.allBills = [
                    	{"name":"eh", "totalDue":10},
                    	{"name":"eh2", "totalDue":20}
                    ];
                    console.log($scope.allBills);
                    $scope.bill = "";
                    $scope.updatePaymentAmount();
                }
                
                $scope.updateBills = function() {
                	$http.get("/itrust2/api/v1/").then();
                	$scope.updatePaymentAmount();
                }
            	
            	//Checks for duplicate active CPT Codes
            	$scope.duplicateCodeCheck = function() {
                    $scope.isDuplicate = false;
            		for (var i = 0, len = $scope.cpts.length; i < len; i++) {
                    	if ($scope.cpt.code == $scope.cpts[i].code) {
                            $scope.isDuplicate = true;
                    		return $scope.isDuplicate;
                    	}
                    }
            		
            		return $scope.isDuplicate;
            	}

            	//Add CPT Code to active codes
                $scope.addPayment = function() {
                	if ($scope.duplicateCodeCheck()) {
                		$scope.errorAdding = "Could not add CPT Code: Code already exists";
                    } else if ($scope.cpt.description.length > 250) {
                        $scope.errorAdding = "Could not add CPT Code: Description exceeds character limit of 250";
                    } else if ($scope.cpt.cost < 0 || (/[+-]?[0-9]+/.test($scope.cpt.cost) == false)) {
                        $scope.errorAdding = "Could not add CPT Code: Invalid cost entered";
                    } else if (/^[0-9]{5}$/.test($scope.cpt.code) == false) {
                        $scope.errorAdding = "Could not add CPT Code: Code doesn't meet specifications";
                    } else {
                        $http.post("/iTrust2/api/v1/cptcodes", $scope.cpt).then(
                            function (response) {
                                $scope.updateTable();
                                $scope.cpt.code = "";
                                $scope.cpt.description = "";
                                $scope.cpt.cost = "";
                                $scope.errorAdding = "";
                            }, function (rejection) {
                                $scope.errorAdding = "Could not add CPT Code";
                            });
                        //scope.updateTable();
                    }
                    console.log($scope.errorAdding);
                }
            	
            	/**
            	*/
            	$scope.showBill = function() {
            		console.log($scope.bill.name);
            		$scope.updatePaymentAmount();
            	}
            	
            	/**
            		Updates Payment Amount input field on change
            		Parameters:
            			$scope.paymentMethod
            			$scope.
            	*/
            	$scope.updatePaymentAmount = function() {
            			if ( $scope.bill != 0 ) {
            				if ( $scope.paymentMethod == 1 ) {
            					$scope.paymentAmount = $scope.bill.totalDue;
            				}
            				$scope.isFull = $scope.paymentMethod
            			} else {
            				$scope.isFull = 1;
            			}
            	}
                
                //Builds the CPT object's data
                $scope.buildPayment = function(payment) {
					$scope.payment = {};
					$scope.payment.id = payment.id;
					$scope.payment.code = payment.code;
					$scope.payment.description = payment.description;
					$scope.payment.cost = payment.cost;
				}
                
                

                    // update table on each page load
                    $scope.updateTable();
                });

        </script>

		<div ng-app="myApp" ng-controller="billsCtrl as crtl">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<div class="panel panel-primary">

							<!-- active cpt's header -->
							<div class="panel-heading">
								<h3>Billing Member: Pay Bill</h3>
							</div>
							<div class="panel-body">
							    <label>Previous Payments</label>
								<table class="table table-bordered" name="payment_table">

									<!-- table column headers -->
									<thead>
										<tr>
											<th>Visit ID</th>
											<th>Patient</th>
											<th>Date</th>
											<th>Action</th>
										</tr>
									</thead>

									<!-- CPT code for every row, ordered by code ascending -->
									<tbody>
										<tr name="paymentTableRow" ng-repeat="p in payments | orderBy: 'date'"
											codeId={{l.id}}>
											<td name="codeCell">{{l.code}}</td>
											<td name="descriptionCell">{{l.description}}</td>
											<td name="costCell">{{l.cost}}</td>
											<td name="actionCell"><input type="button" value="Edit"
												    class="btn btn-primary" ng-click="editCPT(l)" />
												<input type="button" value="Delete" class="btn btn-primary"
												    ng-click="removeCPT(l)" /></td>
										</tr>
									</tbody>
								</table>
								<script type="text/ng-template" id="static">
                                    <td>{{cpt.</td>
                                </script>

								<br>
								<!-- MAKE A PAYMENT SECTION -->
								<div class="row">
									<div class="col-md-12">
										<div class="panel panel-default">
											<div class="panel-heading">Select A Bill</div>
											<div class="panel-body">
												<form class="form-horizontal" role="form" name="viewLogForm"
													ng-submit="ctrl.searchByDate()">
													<br>

													<div class="row">

														<!-- Choose Payment Section -->
														<div class="col-md-5">
															<label>Bills</label>
															<div class="row">
																<div class="col-md-7">
																	<select class="form-control" name="bills" ng-change="showBill()"
																		ng-model="bill" value={{b}} required="required" ng-options="b as bill.name for bill in allBills">{{b.name}} <!-- ng-options="b as bill.name for bill in allBills" -->
																	</select>
																</div>
															</div>
														</div>

														<div class="col-md-5">
															<label for="date">Date:</label>
															<div class="row">
																<div class="col-md-7">
																	<input id="date" type="date" class="form-control" name="date"
																		ng-model="paymentDate" required="true" />
																</div>
															</div>
														</div>
													</div>
													<br> <br>
													<!-- BOX PAYMENT AMOUNT -->
													<div class="panel panel-default">
														<div class="panel-heading"> Make a Payment </div>
														<div class="panel-body">
															<label id="billheader">Bill Total</label><br>
															<input type="text" id="billheader" ng-model="totalBill" disabled></input><br>
															<div class="col-md-5">
																<label>Payment Method</label><br>
																<input type="radio" id="cash" name="payment_method" value="Cash">
																<label for="cash">Cash</label>
																<br>
																<input type="radio" id="creditcard" name="payment_method" value="Credit Card">
																<label for="creditcard">Credit Card</label>
																<br>
																<input type="radio" id="check" name="payment_method" value="Check">
																<label for="check">Check</label>
																<br>
																<input type="radio" id="insurance" name="payment_method" value="Insurance">
																<label for="insurance">Insurance</label>
																<br>
															</div>
															<div class="col-md-5">
																<!-- PAYMENT METHOD -->
																<label>Payment Type</label><br>
																	<input type="radio" id="fullpayment" name="payment_type" value=1 ng-model="paymentMethod" ng-change="updatePaymentAmount()">
																	<label for="partialpayment">Full Payment</label>
																	<br>
																	<input type="radio" id="partialpayment" name="payment_type" value="" ng-model="paymentMethod" ng-change="updatePaymentAmount()">
																	<label for="check">Partial Payment</label>
																	<br>
																<label>Payment Amount</label><br>
																<input type="number" id="paymentamount" name="paymentamount" ng-model=paymentAmount ng-disabled="isFull">
																
															</div>
														</div>
													</div>
													<!-- SUBMIT BUTTON -->
													<div>
														<button class="btn btn-primary"
															ng-click="addCode()">Submit</button>
													</div>
												</form>
												<div>
							                        <!-- <h4 style="color: red" ng-show="addCodeForm.$valid">Code doesn't meet specifications</h4>  -->
							                        <p style="color: red" ng-model="errorAdding" id="errP">{{errorAdding}}</p>
						                        </div>
											</div>
										</div>
									</div>
									<br /> 
									<a style="padding-left: 30px" href="archivedCPTCodes">Archived CPT Codes</a>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

		</div>
</body>

</html>